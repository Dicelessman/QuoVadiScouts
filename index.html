<!doctype html>
<html lang="it" class="no-js">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
  <title>Quovadiscout - Strutture & Terreni</title>
  <script>
    // Rimuovi classe no-js se JavaScript √® abilitato
    document.documentElement.classList.remove('no-js');
    document.documentElement.classList.add('js');
  </script>
  <!-- CSS critico inline per first paint -->
  <style id="critical-css">
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .app-header {
      display: flex;
      align-items: center;
      min-height: 56px;
      padding: 8px 12px;
      background: #2f6b2f;
      color: #fff;
    }

    .app-title {
      font-size: 18px;
      margin: 0;
    }

    .main-map-container {
      min-height: 280px;
    }

    .results-container {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }

    .loading-indicator {
      display: none;
    }

    .loading-indicator .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e0e0e0;
      border-top-color: #2f6b2f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <meta name="description" content="Sistema avanzato per la gestione di strutture e terreni scout" />
  <meta name="theme-color" content="#2f6b2f" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="QuoVadiScout" />
  <script>
    // Logger shim globale con cattura delle funzioni console originali
    (function () {
      window.DEBUG = window.DEBUG === true ? true : false;
      if (!window.__console) {
        window.__console = {
          log: console.log.bind(console),
          info: (console.info || console.log).bind(console),
          debug: (console.debug || console.log).bind(console),
          warn: (console.warn || console.log).bind(console),
          error: console.error.bind(console)
        };
      }
      if (!window.log) {
        window.log = {
          info: (...args) => window.DEBUG && window.__console.log(...args),
          debug: (...args) => window.DEBUG && window.__console.debug(...args),
          warn: (...args) => window.__console.warn(...args),
          error: (...args) => window.__console.error(...args)
        };
      }
    })();
  </script>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
  <!-- preconnect limitati a 3 origini: gstatic, unpkg, OSM (a) -->
  <style>
    /* Font Awesome: forza font-display: swap per i webfont */
    @font-face {
      font-family: "Font Awesome 6 Free";
      font-style: normal;
      font-weight: 900;
      font-display: swap;
      src: url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2") format("woff2");
    }

    @font-face {
      font-family: "Font Awesome 6 Free";
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-regular-400.woff2") format("woff2");
    }
  </style>
  <link rel="preload" href="/styles.css" as="style">
  <link rel="manifest" href="/api/manifest.js" />
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèïÔ∏è</text></svg>">
  <link rel="preload" href="styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="styles.css">
  </noscript>
  <link rel="preload" href="geolocation-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="geolocation-styles.css">
  </noscript>
  <!-- Font Awesome non-blocking -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style"
    onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </noscript>
  <script src="maps.js?v=1.3.3" defer></script>
  <!-- Cloudinary SDK -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript" defer></script>
  <!-- Runtime config (Vercel serverless) -->
  <script src="/api/firebase-config.js" defer></script>
  <script src="/api/cloudinary-config.js" defer></script>
  <!-- Export libraries caricati on-demand in export.js -->
  <!-- Maps libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style"
    onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  </noscript>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>
  <link rel="preload" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" as="style"
    onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  </noscript>
  <link rel="preload" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" as="style"
    onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  </noscript>
</head>

<body>
  <!-- Fallback no-JavaScript -->
  <noscript>
    <div
      style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 99999; padding: 2rem;">
      <div style="text-align: center; max-width: 500px;">
        <h1 style="color: #2f6b2f; margin-bottom: 1rem;">üèïÔ∏è QuoVadiScout</h1>
        <h2 style="color: #333; margin-bottom: 1rem;">JavaScript √® richiesto</h2>
        <p style="color: #666; margin-bottom: 1.5rem;">Questa applicazione richiede JavaScript per funzionare
          correttamente. Per favore abilita JavaScript nel tuo browser.</p>
        <p style="color: #999; font-size: 0.9rem;">Abilita JavaScript e ricarica la pagina.</p>
      </div>
    </div>
  </noscript>

  <!-- Skip Navigation Link per Accessibilit√† -->
  <a href="#main-content" class="sr-only skip-link">Salta al contenuto principale</a>

  <!-- Mobile-First Header -->
  <header class="app-header">
    <div class="header-main">
      <div class="header-brand">
        <h1 class="app-title">üèïÔ∏è QuoVadiScout </h1>
      </div>
      <div class="header-actions">
        <button id="menuToggle" class="btn-menu" aria-label="Menu principale">
          <span class="hamburger"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- Search Bar -->
  <div class="search-section" role="search">
    <div class="search-container">
      <input id="search" class="search-input" placeholder="Cerca strutture..." />
      <button id="clearSearch" class="search-clear-btn" aria-label="Cancella ricerca" style="display: none;">‚úï</button>
    </div>
  </div>

  <!-- Main Map -->
  <div id="mainMapContainer" class="main-map-container">
    <div class="map-header">
      <h3 class="map-title">üó∫Ô∏è Mappa Strutture</h3>
      <div class="map-controls">
        <div class="map-layers-dropdown" style="position: relative;">
          <button id="layersMenuBtn" class="btn-map-control" title="Layer aggiuntivi">üó∫Ô∏è</button>
          <div id="layersMenu" class="layers-menu hidden">
            <div class="layers-menu-header">Layer Overlay</div>
            <label class="layer-option">
              <input type="checkbox" id="layer-railway" data-layer="railway">
              <span>üöÇ Rete Ferroviaria</span>
            </label>
            <label class="layer-option">
              <input type="checkbox" id="layer-hiking" data-layer="hiking">
              <span>ü•æ Sentieri Escursionistici</span>
            </label>
            <label class="layer-option">
              <input type="checkbox" id="layer-cycling" data-layer="cycling">
              <span>üö¥ Piste Ciclabili</span>
            </label>
            <label class="layer-option">
              <input type="checkbox" id="layer-mtb" data-layer="mtb">
              <span>üöµ Percorsi MTB</span>
            </label>
            <div class="layers-menu-divider"></div>
            <button id="clearAllLayersBtn" class="layer-clear-btn">
              üóëÔ∏è Rimuovi Tutti i Layer
            </button>
          </div>
        </div>
        <button id="centerMapBtn" class="btn-map-control" title="Centro su di me">üìç</button>
        <button id="toggleMapBtn" class="btn-map-control" title="Mostra/Nascondi mappa">üëÅÔ∏è</button>
      </div>
    </div>
    <div id="mainMap" class="main-map"></div>
  </div>

  <!-- Main Navigation Menu -->
  <nav id="mainMenu" class="main-menu hidden" role="navigation" aria-label="Menu principale">
    <div class="menu-sections">
      <!-- Search & Filters -->
      <section class="menu-section">
        <h3 class="menu-section-title">üîç Ricerca & Filtri</h3>
        <div class="menu-items">
          <button class="menu-item" onclick="mostraRicercaAvanzata()">
            <span class="menu-icon"><i class="fas fa-search"></i></span>
            <span class="menu-label">Ricerca Avanzata</span>
          </button>
          <button class="menu-item" id="sortMenuBtn">
            <span class="menu-icon"><i class="fas fa-sort-amount-down"></i></span>
            <span class="menu-label">Ordina per</span>
            <select id="sort-by" class="menu-select">
              <option value="struttura">Nome</option>
              <option value="luogo">Luogo</option>
              <option value="provincia">Provincia</option>
            </select>
          </button>
          <button class="menu-item" id="savedFiltersBtn">
            <span class="menu-icon"><i class="fas fa-bookmark"></i></span>
            <span class="menu-label">Filtri Salvati</span>
            <select id="saved-filters" class="menu-select">
              <option value="">Seleziona filtro...</option>
            </select>
          </button>
        </div>
      </section>

      <!-- Personal Lists -->
      <section class="menu-section">
        <h3 class="menu-section-title">üìã Le Mie Liste</h3>
        <div class="menu-items">
          <button id="exportBtn" class="menu-item">
            <span class="menu-icon"><i class="fas fa-list"></i></span>
            <span class="menu-label">Elenco Personale</span>
            <span id="contatore-elenco" class="menu-badge">0</span>
          </button>
        </div>
      </section>



      <!-- Actions -->
      <section class="menu-section">
        <h3 class="menu-section-title">‚ö° Azioni Rapide</h3>
        <div class="menu-items">
          <button id="add-btn" class="menu-item menu-item-accent">
            <span class="menu-icon"><i class="fas fa-plus"></i></span>
            <span class="menu-label">Aggiungi Struttura</span>
          </button>
          <button id="resetBtn" class="menu-item">
            <span class="menu-icon"><i class="fas fa-undo"></i></span>
            <span class="menu-label">Reset Filtri</span>
          </button>
          <div class="view-toggle menu-item">
            <span class="menu-icon"><i class="fas fa-eye"></i></span>
            <span class="menu-label">Visualizzazione</span>
            <button id="viewToggle" class="view-switch">
              <span class="view-icon"><i class="fas fa-list"></i></span>
              <span class="view-label">Elenco</span>
            </button>
          </div>
        </div>
      </section>

      <!-- User & Settings -->
      <section class="menu-section">
        <h3 class="menu-section-title">‚öôÔ∏è Impostazioni</h3>
        <div class="menu-items">
          <button id="themeToggle" class="menu-item">
            <span class="menu-icon"><i class="fas fa-moon"></i></span>
            <span class="menu-label">Cambia Tema</span>
          </button>
          <button id="userBtn" class="menu-item">
            <span class="menu-icon"><i class="fas fa-user"></i></span>
            <span class="menu-label">Utente</span>
          </button>
        </div>
      </section>

      <!-- App Management -->
      <section class="menu-section">
        <h3 class="menu-section-title">üìä Gestione App</h3>
        <div class="menu-items">
          <button class="menu-item" onclick="mostraModaleSincronizzazione()">
            <span class="menu-icon"><i class="fas fa-sync-alt"></i></span>
            <span class="menu-label">Sincronizza con Firestore</span>
          </button>
          <button class="menu-item" onclick="mostraFeedAttivita()">
            <span class="menu-icon"><i class="fas fa-history"></i></span>
            <span class="menu-label">Feed Attivit√†</span>
          </button>
          <button class="menu-item" onclick="location.href='dashboard.html'">
            <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
            <span class="menu-label">Dashboard</span>
          </button>
        </div>
      </section>

      <!-- Help & Support -->
      <section class="menu-section">
        <h3 class="menu-section-title">üÜò Aiuto & Supporto</h3>
        <div class="menu-items">
          <button class="menu-item" onclick="mostraAiuto()">
            <span class="menu-icon"><i class="fas fa-question-circle"></i></span>
            <span class="menu-label">Guida Rapida</span>
          </button>
          <button class="menu-item" onclick="mostraAbout()">
            <span class="menu-icon"><i class="fas fa-info-circle"></i></span>
            <span class="menu-label">Informazioni App</span>
          </button>
          <button class="menu-item" onclick="runSystemTests()">
            <span class="menu-icon"><i class="fas fa-flask"></i></span>
            <span class="menu-label">Test Sistemi</span>
          </button>
        </div>
      </section>
    </div>
  </nav>

  <!-- Main Content -->
  <main id="main-content" class="main-content" role="main">
    <!-- Results Counter -->
    <div class="results-header">
      <div class="results-info">
        <span id="resultsCount" class="results-count">0 strutture</span>
        <span id="resultsStatus" class="results-status"></span>
      </div>
    </div>

    <!-- Results Grid -->
    <section id="results" class="results-container">
      <!-- Cards will be dynamically inserted here -->
    </section>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-indicator hidden">
      <div class="loading-spinner"></div>
      <span class="loading-text">Caricamento...</span>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state hidden">
      <div class="empty-icon"><i class="fas fa-search"></i></div>
      <h3 class="empty-title">Nessuna struttura trovata</h3>
      <p class="empty-description">Prova a modificare i filtri o aggiungi una nuova struttura</p>
      <button id="addBtnEmpty" class="btn-primary"><i class="fas fa-plus"></i> Aggiungi Struttura</button>
    </div>
  </main>

  <!-- Modale di modifica -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <button id="closeModal" class="close"><i class="fas fa-times"></i></button>
      <h2>Modifica struttura</h2>
      <form id="editForm"></form>
      <div class="modal-actions">
        <button id="saveBtn"><i class="fas fa-save"></i> Salva</button>
        <button id="deleteBtn" class="danger"><i class="fas fa-trash"></i> Elimina</button>
        <button id="cancelBtn"><i class="fas fa-times"></i> Annulla</button>
      </div>
    </div>
  </div>

  <!-- Reindirizza solo log/info/debug verso logger centralizzato (evita warn/error) -->
  <script>
    (function () {
      if (window.log) {
        console.log = function () { window.log.info.apply(window.log, arguments); };
        console.info = function () { window.log.info.apply(window.log, arguments); };
        console.debug = function () { window.log.debug.apply(window.log, arguments); };
      }
    })();
  </script>

  <script src="maps.js?v=1.3.3" defer></script>
  <script src="export.js" defer></script>
  <script src="push-notifications.js" defer></script>
  <script src="offline-sync.js" defer></script>
  <!-- cloudinary-config.js rimosso: ora caricato da /api/cloudinary-config.js -->
  <script src="media-manager.js" defer></script>
  <script src="virtual-scroll.js" defer></script>
  <script src="integrations.js" defer></script>
  <script src="gestures.js" defer></script>
  <script src="smart-notifications.js" defer></script>
  <script src="analytics.js" defer></script>
  <script src="backup-sync.js" defer></script>
  <script src="config.js" defer></script>
  <script src="test-systems.js" defer></script>
  <script src="toast-notifications.js" defer></script>
  <!-- Geolocalizzazione -->
  <script src="geolocation-config.js" defer></script>
  <script src="geolocation.js" defer></script>
  <script src="geolocation-ui.js" defer></script>
  <script src="geolocation-integration.js" defer></script>
  <!-- Configurazione icone personalizzate -->
  <script src="icons-config.js" defer></script>
  <!-- Gestione errori -->
  <script src="error-handler.js" defer></script>
  <script type="module" src="script.js?v=1.3.3"></script>

  <script>
    // Registrazione Service Worker per PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // Prova a registrare il service worker
          const registration = await navigator.serviceWorker.register('./service-worker.js');
          log.info('‚úÖ Service Worker registrato:', registration.scope);

          // Gestione aggiornamenti automatici
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // Nuovo service worker disponibile
                showUpdateNotification();
              }
            });
          });

          // Listener per messaggi dal service worker
          navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data.action === 'SW_UPDATED') {
              log.info('üîÑ Service Worker aggiornato');
            }
          });

          // Controlla aggiornamenti ogni 30 minuti
          setInterval(() => {
            registration.update();
          }, 30 * 60 * 1000);

        } catch (error) {
          log.warn('‚ö†Ô∏è Service Worker non disponibile (modalit√† sviluppo):', error.message);
          // In modalit√† sviluppo, continua senza service worker
          log.info('üì± App funzionante senza PWA features');
        }
      });
    }

    // Mostra notifica di aggiornamento
    function showUpdateNotification() {
      // Rimuovi notifica esistente se presente
      const existingNotification = document.getElementById('updateNotification');
      if (existingNotification) {
        existingNotification.remove();
      }

      const notification = document.createElement('div');
      notification.id = 'updateNotification';
      notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #2f6b2f;
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 350px;
    animation: slideInRight 0.3s ease-out;
  `;

      notification.innerHTML = `
    <div style="flex: 1;">
      <div style="font-weight: 500; margin-bottom: 4px;">üîÑ Nuova versione disponibile!</div>
      <div style="font-size: 14px; opacity: 0.9;">Ricarica la pagina per aggiornare l'app</div>
    </div>
    <button onclick="location.reload()" style="
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    ">Aggiorna ora</button>
    <button onclick="this.closest('#updateNotification').remove()" style="
      background: none;
      color: white;
      border: none;
      padding: 4px;
      cursor: pointer;
      font-size: 18px;
      opacity: 0.7;
    ">√ó</button>
  `;

      document.body.appendChild(notification);

      // Auto-rimuovi dopo 10 secondi
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 10000);
    }

    // Gestione installazione PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;

      // Mostra pulsante installazione personalizzato
      const installBtn = document.createElement('button');
      installBtn.textContent = 'üì± Installa App';
      installBtn.className = 'btn-install';
      installBtn.style.cssText = `
    background: #2f6b2f;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 8px;
  `;

      installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          log.info('Risultato installazione:', outcome);
          deferredPrompt = null;
        }
      });

      // Aggiungi pulsante alla topbar
      const controls = document.querySelector('.controls-secondary');
      if (controls) {
        controls.appendChild(installBtn);
      }
    });

    // Gestione installazione completata
    window.addEventListener('appinstalled', () => {
      log.info('‚úÖ PWA installata con successo');
      deferredPrompt = null;
    });

    // Inizializzazione icone personalizzate
    document.addEventListener('DOMContentLoaded', () => {
      // Aggiorna tutte le icone del menu
      if (typeof updateMenuIcons === 'function') {
        updateMenuIcons();
      }

      // Aggiorna icone dinamiche se necessario
      setTimeout(() => {
        // Forza aggiornamento icone dopo caricamento completo
        if (typeof updateMenuIcons === 'function') {
          updateMenuIcons();
        }
      }, 1000);
    });
  </script>

</body>

</html>